# MCP 浏览器工具优化说明

## 优化内容

### 1. 代码重构和错误处理优化

#### 浏览器工具类 (`browser_tools.py`)
- **添加配置系统**: 使用 `dataclass` 实现可配置的浏览器设置
- **改进错误处理**: 添加锁机制防止重复启动，更好的异常处理
- **代码结构优化**: 提取公共方法，减少重复代码
- **新增功能**: 添加 `get_element_text` 和 `get_element_attribute` 工具

#### 服务器代码 (`server.py`)
- **响应格式统一**: 添加 `_create_tool_response` 和 `_create_error_response` 辅助函数
- **性能监控**: 添加 `log_performance` 装饰器监控工具执行时间
- **配置管理**: 使用 `config.py` 集中管理配置
- **日志优化**: 改进日志格式和级别管理
- **工具扩展**: 添加截图、JavaScript 执行、元素操作等新工具

### 2. 新增功能

#### 浏览器工具
- `get_element_text`: 获取元素文本内容
- `get_element_attribute`: 获取元素属性值
- `take_screenshot`: 截取屏幕
- `execute_javascript`: 执行 JavaScript 代码

#### 服务器工具
- 所有新工具都已添加到工具列表中
- 统一的错误处理和响应格式

### 3. 配置系统

#### 配置文件 (`config.py`)
- `ServerConfig`: 服务器配置（名称、版本、日志设置）
- `BrowserConfig`: 浏览器配置（无头模式、用户代理、超时设置）
- `ToolConfig`: 工具配置（内容长度限制、链接数量限制等）
- `setup_logging`: 日志配置函数
- `get_data_dir`: 获取数据目录

### 4. 性能优化

- **性能监控**: 所有工具函数都添加了执行时间监控
- **资源管理**: 改进的浏览器启动和关闭机制
- **并发控制**: 使用异步锁防止竞态条件

### 5. 错误处理改进

- **统一错误响应**: 标准化的错误处理和响应格式
- **详细日志**: 更详细的错误信息和上下文
- **异常捕获**: 更全面的异常捕获和处理

## 使用方法

### 基本使用
```bash
uvx mcp-browser-tools
```

### 配置使用
可以通过修改 `config.py` 来调整浏览器和服务器配置。

### 新增工具使用示例

#### 获取元素文本
```json
{
  "name": "get_element_text",
  "arguments": {
    "selector": "h1.title"
  }
}
```

#### 获取元素属性
```json
{
  "name": "get_element_attribute",
  "arguments": {
    "selector": "a.link",
    "attribute": "href"
  }
}
```

#### 执行 JavaScript
```json
{
  "name": "execute_javascript",
  "arguments": {
    "script": "return document.title"
  }
}
```

#### 截取屏幕
```json
{
  "name": "take_screenshot",
  "arguments": {
    "path": "screenshot.png"
  }
}
```

## 监控和日志

服务器现在提供详细的性能监控和日志记录，包括：
- 每个工具的执行时间
- 错误信息和堆栈跟踪
- 资源使用情况
- 配置信息

## 兼容性

- 保持与原有工具的兼容性
- 向后兼容所有现有功能
- 扩展功能不会影响现有工作流

## 总结

通过这次优化，MCP 浏览器工具现在具有：
1. 更好的错误处理和稳定性
2. 更丰富的功能集
3. 可配置的系统设置
4. 详细的性能监控
5. 更好的代码结构和可维护性

这些改进使得工具更加健壮、功能更强大，同时保持了良好的兼容性。